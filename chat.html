<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Chat</title>
	<link rel="stylesheet" type="text/css" href="css/main.css">
</head>
<body>
 	<div id="chat" onClick="open_chatbox();"> Chat Now </div>
 	<div id="chatBox"><div onclick="closeChat()" id="close">X</div> <br><br>
 	<div class='printchatbox' id='printchatbox'>
		<div class="chat">
		<!-- <input type="text" name="msg" class="chat-name" placeholder="Enter you name here."> -->
			<div class="chat-messages"></div>
		<textarea class="chat-text-area" placeholder="Type message"></textarea>
		<div class="chat-status">Status : <span>Idle</span></div>
		</div>
	</div>

	<script type="text/javascript" src="http://127.0.0.1:8080/socket.io/socket.io.js"></script>  
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"> </script>

 	<script type="text/javascript">
 		function open_chatbox()
 			{
 			$('#chat').fadeOut(500);
 			$('#chatBox').fadeIn(1000);
		 }
 		function closeChat()
 			{
 			$('#chatBox').fadeOut(500);
 			$('#chat').fadeIn(1000);
 		}
 		</script>
  	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

 	<script type="text/javascript">
 		function open_chatbox()
 			{
 			$('#chat').fadeOut(500);
 			$('#chatBox').fadeIn(1000);
 		}
 		function closeChat()
 			{
 			$('#chatBox').fadeOut(500);
 			$('#chat').fadeIn(1000);
 		}
 //var inputBox = document.getElementById('chatinput');
 	</script>
	<script type="text/javascript">
		(function() {
			var givingIntro = 0;
			var getNode = function(s) {
				return document.querySelector(s);
			};
		status = getNode('.chat-status span');
		textarea = getNode('.chat-text-area');
		// chatname = getNode('.chat-name');
		messages = getNode('.chat-messages');
		statusDefault = status.textContent;
		setStatus = function(s) {
			status.textContent = s;
			if(s != statusDefault) {
				var delay = setTimeout(function() {
					setStatus(statusDefault);
					clearInterval(delay);
				},3000);
			}
		};
		setStatus("Testing");

		try {
			var socket = io.connect('http://127.0.0.1:8080');
		}
		catch(e) {
			//do something if connection fails or maybe not.
		}
		if(socket!==undefined) {
			var userinfo = JSON.parse(localStorage.getItem("userInfo")); 
			// fetched from local storage
			if (userinfo == null){
				console.log("undefined string");
				socket.emit('greeting', "");	
				socket.on('newUserIntro', function(data) { 
					console.log(data); 
					var message = document.createElement('div');
					message.setAttribute('class', 'chat-message-left');
					message.textContent = data;
					messages.appendChild(message);
					messages.insertBefore(message , messages.lastChild);
					givingIntro = 1;
				});
			}
			else {
				socket.emit('greeting', userinfo);
			}


			socket.on('ReturningUser', function(data) {
				console.log(data);
				var clear = document.createElement('div');
				clear.setAttribute('class', 'clear');
				var message = document.createElement('div');
				message.setAttribute('class', 'chat-message-left');
				message.textContent = data;
				messages.appendChild(message);
				messages.appendChild(clear);
				messages.insertBefore(message , messages.lastChild);
				messages.insertBefore(clear, messages.lastChild);
				givingIntro = 0;
				var retrievedData = localStorage.getItem("messages");
				var chatData = JSON.parse(retrievedData);
				var userData = JSON.parse(localStorage.getItem("userInfo"));
				var userName = userData.name;
				localStorage.setItem('messages', JSON.stringify(chatData));
					if(chatData.length) {
						for (var x=0; x<chatData.length; x=x+1) {
							var message = document.createElement('div');
							var clear = document.createElement('div');
							clear.setAttribute('class', 'clear');
								if(chatData[x].name == userName) {
									message.setAttribute('class', 'chat-message-right');
								}
								else {
									message.setAttribute('class', 'chat-message-left');
								}
							message.textContent = chatData[x].message;	
							messages.appendChild(message);
							messages.appendChild(clear);
							messages.insertBefore(message , messages.lastChild);
							messages.insertBefore(clear, messages.lastChild);
						}
					}
			});

			// socket.on('newUserIntro', function(data) { console.log(data); });
			// socket.on('ReturningUser', function(data) { console.log(data); });
			socket.on('output', function (data) {
			console.log("chat starts");
			var obj={};
			var user= {};
			//localStorage.setItem('messages', JSON.stringify(obj));
			// localStorage.setItem('userInfo', JSON.stringify(user));
				if(data.length) {
					for(var x =0; x<data.length; x=x+1) {
						var message = document.createElement('div');
						var clear = document.createElement('div');
						clear.setAttribute('class', 'clear');
						message.setAttribute('class', 'chat-message-right');
						var sender = document.createElement('div');
						sender.setAttribute('class', 'sender');
						sender.textContent = data[x].name;
						console.log(sender.textContent);
						var elem = sender.textContent;
						message.textContent = data[x].message;	
						messages.appendChild(message);
						messages.appendChild(clear);
						messages.insertBefore(message , messages.lastChild);
						messages.insertBefore(clear, messages.lastChild);
					}
				}
					else {
						var message = document.createElement('div');
						var clear = document.createElement('div');
						clear.setAttribute('class', 'clear');
						message.setAttribute('class', 'chat-message-right');
						message.textContent = data.message;	
						messages.appendChild(message);
						messages.appendChild(clear);
						messages.insertBefore(message , messages.lastChild);
					}

					var retrievedData = localStorage.getItem("messages");
					var chatData = JSON.parse(retrievedData);
					var userData = JSON.parse(localStorage.getItem("userInfo"));
					var userName = userData.name;
					chatData.push(data);
					localStorage.setItem('messages', JSON.stringify(chatData));
			});

			socket.on('introMessageResponse', function(userInfo) {
				localStorage.setItem('userInfo', JSON.stringify(userInfo));
				userinfo = userInfo;
				givingIntro = 2;
				var message = document.createElement('div');
				var clear = document.createElement('div');
				clear.setAttribute('class', 'clear');
				message.setAttribute('class', 'chat-message-left');
				message.textContent = "Hello " + userInfo.name+ " ! What is your email ?";
				messages.appendChild(message);
				messages.appendChild(clear);
				messages.insertBefore(message , messages.lastChild);
				messages.insertBefore(clear, messages.lastChild);

				});

			socket.on('newEmailResponse', function(userInfo) {
				console.log(userInfo);
				var obj=[];
				localStorage.setItem('messages', JSON.stringify(obj));
				localStorage.setItem('userInfo', JSON.stringify(userInfo));
				var message = document.createElement('div');
				var clear = document.createElement('div');
				clear.setAttribute('class', 'clear');
				message.setAttribute('class', 'chat-message-left');
				message.textContent = "Thanks " +userInfo.name+ "!. We'll get back to you shortly.";
				messages.appendChild(message);
				messages.appendChild(clear);
				messages.insertBefore(message , messages.lastChild);
				messages.insertBefore(clear, messages.lastChild);
				givingIntro = 0;
				});
			// socket.on('greeting', function(greet) {
			// 	console.log(greet);
			// });
			socket.on('status', function(data) {
				console.log("Status ", data);
				setStatus((typeof data === 'object')? data.message : data );
				if(data.clear === true) {
					textarea.value='';
				}
			});
			textarea.addEventListener('keydown', function(event) {
				var self = this; 
				// console.log(event);
				if(event.which===13 && event.shiftKey === false) {
					if (givingIntro==1) {
						var user = JSON.parse(window.localStorage.getItem("userInfo"));
						console.log("User should enter name");
						socket.emit('introMessage', {
							name : name,
							message : self.value
						});

					} else if(givingIntro==0){
						var user = JSON.parse(window.localStorage.getItem("userInfo"));
						console.log("User should enter chat");
						socket.emit('input', {
							name : user.name,
							message : self.value
						});	
					}
					else {
						console.log("User should enter email");
						var user = JSON.parse(window.localStorage.getItem("userInfo"));
						socket.emit('newEmail', {
							name : user.name,
							id: user.id,
							email : self.value
						});
					}
					
					console.log("Send");
				}
			})
		}
		
	})();
</script>
</body>
</html>