<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Chat</title>
	<link rel="stylesheet" type="text/css" href="css/main.css">
</head>
<body>
 <div id="chat" onClick="open_chatbox();"> Chat Now </div>
 <div id="chatBox"><div onclick="closeChat()" id="close">X</div> <br><br>
 <div class='printchatbox' id='printchatbox'>
	<div class="chat">
		<input type="text" name="msg" class="chat-name" placeholder="Enter you name here.">
			<div class="chat-messages"></div>
		<textarea class="chat-text-area" placeholder="Type message"></textarea>
	<div class="chat-status">Status : <span>Idle</span></div>
</div>
</div>

<script type="text/javascript" src="http://127.0.0.1:8080/socket.io/socket.io.js"></script>  
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"> </script>

 <script type="text/javascript">
 function open_chatbox()
 {
 $('#chat').fadeOut(500);
 $('#chatBox').fadeIn(1000);
 }
 function closeChat()
 {
 $('#chatBox').fadeOut(500);
 $('#chat').fadeIn(1000);
 }
 </script>
  <script   
  src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js">  
  </script>

 <script type="text/javascript">
 function open_chatbox()
 {
 $('#chat').fadeOut(500);
 $('#chatBox').fadeIn(1000);
 }
 function closeChat()
 {
 $('#chatBox').fadeOut(500);
 $('#chat').fadeIn(1000);
 }
 var inputBox = document.getElementById('chatinput');
 </script>
<script type="text/javascript">
	(function() {
		var getNode = function(s) {
			return document.querySelector(s);
		},
		status = getNode('.chat-status span');
		textarea = getNode('.chat-text-area');
		chatname = getNode('.chat-name');
		messages = getNode('.chat-messages');
		statusDefault = status.textContent;
		setStatus = function(s) {
			status.textContent = s;
			if(s != statusDefault) {
				var delay = setTimeout(function() {
					setStatus(statusDefault);
					clearInterval(delay);
				},3000);
			}
		};
		setStatus("Testing");

		try {
			var socket = io.connect('http://127.0.0.1:8080');
		}
		catch(e) {

		}
		if(socket!==undefined) {
			socket.on('output', function (data) {
				var obj={};
				localStorage.setItem('messages', JSON.stringify(obj));
				if(data.length) {
					for(var x =0; x<data.length; x=x+1) {
						var message = document.createElement('div');
						message.setAttribute('class', 'chat-message');
						message.textContent = data[x].name + ' : ' + data[x].message;	
						messages.appendChild(message);
						messages.insertBefore(message , messages.firstChild);
					}

					localStorage.setItem('messages', JSON.stringify(data));
					var retrievedData = localStorage.getItem("messages");
					var chatData = JSON.parse(retrievedData);
					console.dir(chatData);

				}
			});
			socket.on('status', function(data) {
				setStatus((typeof data === 'object')? data.message : data );
				if(data.clear === true) {
					textarea.value='';
				}
			});
			textarea.addEventListener('keydown', function(event) {
				var self = this, 
				name = chatname.value;
				console.log(event);
				if(event.which===13 && event.shiftKey === false) {
					socket.emit('input', {
						name : name,
						message : self.value
					});
					console.log("Send");
				}
			})
		}
		
	})();
</script>
</body>
</html>