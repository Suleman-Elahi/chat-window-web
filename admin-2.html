<!DOCTYPE html>
<html >
  <head>
    <meta charset="UTF-8">
    <title>Admin Chat</title>
    
    
    <link rel="stylesheet" href="css/reset.css">

    <link rel='stylesheet prefetch' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css'>

    <link rel="stylesheet" href="css/style.css">

    
    
    
  </head>

  <body>

  <div class="container clearfix">
    <div class="people-list" id="people-list">
      <div class="search">
        <input type="text" placeholder="search" />
        <i class="fa fa-search"></i>
      </div>
      <ul class="list"></ul> <!--clients are populated here -->
    </div>
    
    <div class="chat">
      <div class="chat-header clearfix" id ="div_1">
        <div class="chat-about">
          <div class="chat-with">Client 1</div>
        </div>
      </div> 
    <div class="chat-header clearfix" id ="div_2">
        <div class="chat-about">
          <div class="chat-with">Client 2</div>
        </div>
      </div>
      <div class="chat-header clearfix" id ="div_3"> 
        <div class="chat-about">
          <div class="chat-with">Client 3</div>
        </div>
      </div>

      <!-- end chat-header -->
      
      <div class="chat-messages chat-history" id="div1">
        <div class="chats"></div>
      </div> <!-- end chat-history -->
      
      <div class="chat-message clearfix">
        <textarea name="message-to-send" id="message-to-send" class= "chat-text-area" placeholder ="Type your message" rows="3"></textarea>        
      </div> <!-- end chat-message -->
      <div class="chat-status"></div>
    </div> <!-- end chat -->
    
  </div> <!-- end container -->
>
<script id="message-template" type="text/x-handlebars-template">
  <li class="clearfix">
    <div class="message-data align-right">
      <span class="message-data-time" >{{time}}, Today</span> &nbsp; &nbsp;
      <span class="message-data-name" >Olia</span> <i class="fa fa-circle me"></i>
    </div>
    <div class="message other-message float-right">
      {{messageOutput}}
    </div>
  </li>
</script>

<script id="message-response-template" type="text/x-handlebars-template">
  <li>
    <div class="message-data">
      <span class="message-data-name"><i class="fa fa-circle online"></i> Vincent</span>
      <span class="message-data-time">{{time}}, Today</span>
    </div>
    <div class="message my-message">
      {{response}}
    </div>
  </li>
</script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.0/handlebars.min.js'></script>
<script src='http://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js'></script>

<script src="js/index.js"></script>
<script>
$(document).ready(function(){

  // Hide div 2 by default
  $('#div_2').hide();
  $('#div_3').hide();

  $('#link_2').click(function(){ 
      $('#div_1').hide();
      $('#div_2').show();
      $('#div_3').hide();
  });

  $('#link_1').click(function(){ 
      $('#div_2').hide();
      $('#div_3').hide();
      $('#div_1').show();
  });
    $('#link_3').click(function(){ 
      $('#div_2').hide();
      $('#div_3').show();
      $('#div_1').hide();
  }); 
});
    
</script>  
<script type="text/javascript">
    function scroll() { //scroll to bottom of messages
    var d = $('#div1');
    d.scrollTop(d.prop("scrollHeight"));
    }
    
    $(function() {
      scroll();
    });
  </script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.js"></script>  
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"> </script>
<script type="text/javascript">
  var clientId;
  try {
      var socket = io.connect('http://127.0.0.1:8080'); //change this according to your server
      scroll();
    }
  catch(e) {
      //Manage the exception gracefully. Send a PR after doing it :v
    }
  var getNode = function(s) { //returns reference to passed attribute 
    return document.querySelector(s);
  };
  status = getNode('.chat-status span');
  textarea = getNode('.chat-text-area');
  messages = getNode('.chat-messages');
  histories = getNode('.chats'); 
  user = getNode('.list');
  var sendStatus = function(s) {
    socket.emit('status', s);
  };
  statusDefault = status.textContent;
  setStatus = function(s) {
    status.textContent = s;
    if(s != statusDefault) {
    var delay = setTimeout(function() {
      setStatus(statusDefault);
      clearInterval(delay);
      },3000);
    }
  };
  setStatus("Testing");

  var hashed_string = "1c4a81692da3391b57ba6c5afdf11f46"; //for admin connection
  socket.emit(hashed_string);
  socket.on('adminConnect', function(data) {
    data.name = name;
    console.log("Now connected to admin");
    socket.emit('newAdminMessage', data);
  });
  socket.on('newMessage', function(data) { //handles new message from admin
    name = data.name;
    id = data.id + "li";
    clientId = data.id;
    console.log("name : " ,name);
    console.log("id :" ,id);
    if(document.getElementById(id)===null) {
      var client = document.createElement('li');
      client.setAttribute('class', 'clearfix');
      client.innerHTML = '<a href="#" <div id="' +id+ '"class="name">' +name+ '</div></a>';
      var history = document.createElement('div');
      history.setAttribute('id', clientId);
      history.setAttribute("class","userchat");
    }
    else {
      var client = document.getElementById(id);
      var history = document.getElementById(clientId);
      }
      $(".userchat").hide();
      $("#"+clientId).show();
      user.appendChild(client);
      user.insertBefore(client, user.lastChild); 
      var message = document.createElement('div');
      var clear = document.createElement('div');
      clear.setAttribute('class', 'clear');
      message.setAttribute('class', 'message my-message');
      message.textContent = data.message; 
      history.appendChild(message);
      history.appendChild(clear);
      histories.appendChild(history);
      console.log(histories);
      console.log("working newMessage");
      history.insertBefore(message, history.lastChild);
      scroll();
  });
  socket.on('status', function(data) { //clears the textarea and changes the status
    console.log("Status ", data);
    setStatus((typeof data === 'object')? data.message : data );
    if(data.clear === true) {
      textarea.value='';
      }
    });
  socket.on('dbHandler', function(data) { //adds the chat messages to database
        var userName = data.name;
        clientId = data.id;
          if(data.length) {
            for (var x=0; x<data.length; x=x+1) {
              var history = document.createElement('div');
              history.setAttribute('id', clientId);
              history.setAttribute("class","userchat");
              var message = document.createElement('div');
              var clear = document.createElement('div');
              clear.setAttribute('class', 'clear');
                if(data[x].name == userName) { //fetches and displays according to sender
                  message.setAttribute('class', 'message other-message align-right');
                }
                else {
                  message.setAttribute('class', 'message my-message');
                }
            message.textContent = data.message; 
            history.appendChild(message);
            history.appendChild(clear);
            console.log(histories);
            history.insertBefore(message, history.lastChild);
            scroll();
            }
          }

  }); 
  textarea.addEventListener('keydown', function(event) { //sends message on enter and enters next line on shift plus enter
    var self = this; 
    if(event.which===13 && event.shiftKey === false) {
      console.log("Admin should enter chat");
      socket.emit('inputAdmin', {
        id : clientId,
        message : self.value
      });
              var history = document.getElementById(clientId);
              var message = document.createElement('div');
              history.setAttribute('id', clientId);
              history.setAttribute("class","userchat");
              var clear = document.createElement('div');
              clear.setAttribute('class', 'clear');
              var message = document.createElement('div');
              var clear = document.createElement('div');
              clear.setAttribute('class', 'clear');
              message.setAttribute('class', 'message other-message align-right');
              message.textContent = self.value; 
              history.appendChild(message);
              history.appendChild(clear);
              console.log(histories);
              history.insertBefore(message, history.lastChild);
              scroll();
      }

  });

</script>
    
  </body>
</html>
